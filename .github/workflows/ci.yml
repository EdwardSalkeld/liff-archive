name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.6'
          extended: true
          
      - name: Build Hugo site
        run: |
          cd hugo
          hugo
          
      - name: Run HTML validation tests
        run: |
          chmod +x .github/workflows/test-html.sh
          .github/workflows/test-html.sh

  visual-regression-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.6'
          extended: true
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: Run Playwright tests
        run: npm test
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          
      - name: Upload test failure diffs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 30
          
      - name: Comment PR with test results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Check if test-results directory exists
            const testResultsDir = 'test-results';
            if (!fs.existsSync(testResultsDir)) {
              console.log('No test results directory found');
              return;
            }
            
            // Find all diff images
            const diffImages = [];
            const walkDir = (dir) => {
              const files = fs.readdirSync(dir);
              for (const file of files) {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                if (stat.isDirectory()) {
                  walkDir(filePath);
                } else if (file.includes('-diff.png')) {
                  diffImages.push(filePath);
                }
              }
            };
            walkDir(testResultsDir);
            
            // Create comment body
            let commentBody = '## ⚠️ Visual Regression Test Failures\n\n';
            commentBody += `Found ${diffImages.length} screenshot difference(s).\n\n`;
            commentBody += 'Please review the [test report artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed comparison.\n\n';
            commentBody += '### Failed Tests:\n';
            
            for (const diffImg of diffImages) {
              const testName = path.basename(diffImg, '-diff.png');
              commentBody += `- ${testName}\n`;
            }
            
            commentBody += '\n### What to do:\n';
            commentBody += '1. Download the test artifacts from the workflow run\n';
            commentBody += '2. Review the diff images to see what changed\n';
            commentBody += '3. If the changes are intentional, update the golden images by running: `npm run test:update`\n';
            commentBody += '4. Commit the updated snapshots to your branch\n';
            
            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
